<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>みらた運用シミュレーター</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="icon_mirata.svg">
<meta name="theme-color" content="#10b981">

<style>
  :root{ --brand:#0a6cff; --ink:#1f2328; --muted:#6b7280; --line:#e5e7eb;
    --card:#ffffff; --bg:#f7f8fa; --warn:#fff4cc; --danger:#ef4444; --ok:#10b981; }

  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family:"Noto Sans JP",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,
    "Hiragino Kaku Gothic ProN","BIZ UDPGothic","Noto Sans JP",Meiryo,sans-serif;}
  .wrap{max-width:760px;margin:24px auto;padding:0 14px;}
  h1{margin:0 0 18px;font-size:clamp(22px,5vw,30px);letter-spacing:.02em;color:var(--brand);}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;}
  .stack{display:flex;flex-direction:column;gap:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:680px){.row{grid-template-columns:1fr}}
  label{font-size:14px;color:var(--muted)}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);
    border-radius:10px;background:#fff;font-size:16px;box-sizing:border-box;}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;align-items:center}
  button{border:1px solid var(--brand);background:var(--brand);color:#fff;
    padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  button.secondary{background:#fff;color:var(--brand)}
  button.ghost{background:#fff;border-color:var(--line);color:#000}
  .caption{font-size:12px;color:var(--muted)}
  .cols{display:grid;gap:12px;margin-top:14px}
  .cols.cols-3{grid-template-columns:1fr 1fr 1fr}
  .cols.cols-2{grid-template-columns:1fr 1fr}
  @media (max-width:900px){.cols.cols-3,.cols.cols-2{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums;}
  th,td{border-top:1px solid var(--line);padding:8px 10px;text-align:right;vertical-align:middle}
  th:first-child,td:first-child{text-align:center}
  thead th{font-size:13px;color:var(--muted);font-weight:600}
  /* 画面用：縦罫線 */
  table td+td, table th+th{ border-left:1px solid var(--line); }

  .sum{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  @media (max-width:680px){.sum{grid-template-columns:1fr}}
  .kpi{background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .val{font-size:20px;font-weight:800;margin-top:4px}
  .hide{display:none}
  .banner{background:var(--warn);border:1px solid #ffe08a;border-radius:12px;padding:14px 12px;margin-top:12px}
  .disclaimer{margin-top:12px;font-size:12px;color:#6b7280;line-height:1.5}
  .chart-card{height:320px;margin-top:12px;}
  #growthChart{width:100%;height:100%}

  /* ← JSが止まってもターゲット欄は出さない */
  #targetRow{display:none}
  #targetRow.show{display:grid}

  /* オーバーレイ（プラン一覧） */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:50}
  .overlay.show{display:block}
  .sheet{position:fixed;inset:0;display:flex;flex-direction:column;background:#fff}
  .sheet header{border-bottom:1px solid var(--line)}
  .sheet .hwrap{max-width:760px;margin:0 auto;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .sheet main{padding:12px;overflow:auto}
  .center{max-width:760px;margin:0 auto}
  .planlist{display:grid;gap:10px}
  .plancard{border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff}

  /* サムネ／タイトル */
  .plancard .headerGrid{display:grid;grid-template-columns:1fr 2fr;gap:12px;align-items:start}
  @media (max-width:720px){ .plancard .headerGrid{grid-template-columns:1fr} }
  .plancard .thumbLarge{overflow:hidden;border:1px solid var(--line);border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;padding:4px;}
  .plancard .thumbLarge img{width:100%; height:110px; object-fit:contain; object-position:center; display:block;}
  .plancard .titleBox{display:flex;flex-direction:column;gap:8px}
  .plancard input.title{
    font-size:15px;font-weight:700;border:2px solid var(--brand);
    border-radius:10px;padding:10px 12px;width:100%;
    box-shadow:0 0 0 3px rgba(10,108,255,.12);
  }
  .plancard input.title:focus{outline:none; box-shadow:0 0 0 4px rgba(10,108,255,.18);}
  .tag{font-size:11px;color:#fff;background:var(--brand);padding:2px 6px;border-radius:999px}
  .muted{color:#6b7280;font-size:12px}
  .rowbtns{display:flex;gap:6px;flex-wrap:wrap}
  .rowbtns button{padding:6px 8px;border-radius:8px;font-size:12px}
  .rowbtns .danger{border-color:var(--danger);color:var(--danger);background:#fff}
  .rowbtns .ok{border-color:var(--ok);color:#0c8346;background:#fff}
  .mini{margin-top:10px;border-top:1px dashed var(--line);padding-top:8px}
  .mini .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .mini .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .mini table{font-size:11px}
  .mini h4{margin:0 0 4px;font-size:12px;color:#6b7280}
  .mini .gbox{border:1px solid var(--line);border-radius:6px;padding:6px}
  .mini .gbox img{width:100%;max-height:160px;object-fit:contain;border:1px solid var(--line);border-radius:4px;background:#fff}

  /* PDFワーク領域（画面に出ない＆クリック邪魔しない） */
  #pdf-work{position:fixed; left:-10000px; top:-10000px; opacity:0; pointer-events:none; z-index:-1;}

  /* ==== PDF（html2canvas→画像化用のスタイル） ==== */
  .pdf-a4{width:794px;height:1123px; box-sizing:border-box;background:#fff;color:#1f2328;
    padding:28px 24px; display:flex; flex-direction:column; gap:12px; font-family:"Noto Sans JP",sans-serif;}
  .pdf-head{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap}
  .pdf-title{display:flex;align-items:baseline;gap:8px;font-size:20px;font-weight:700;color:#0a6cff}
  .pdf-title .page-badge{font-size:14px;color:#6b7280;white-space:nowrap}
  .pdf-meta{font-size:11px;color:#6b7280;line-height:1.5;margin-top:2px}
  .pdf-card{border:1px solid #e5e7eb;border-radius:8px;padding:10px}
  .pdf-card h3{margin:0 0 6px;font-size:13px;color:#6b7280}
  .pdf-chart{width:100%;height:330px;object-fit:contain;border:1px solid #e5e7eb;border-radius:6px}
  .pdf-table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
  .pdf-table th,.pdf-table td{border-top:1px solid #e5e7eb;padding:4px 5px;text-align:right;font-size:11px}
  .pdf-table th:first-child,.pdf-table td:first-child{text-align:center}
  /* PDF用：縦罫線 */
  .pdf-table td+td, .pdf-table th+th{ border-left:1px solid #e5e7eb; }

  .pdf-note{font-size:10px;color:#6b7280;margin-top:6px;line-height:1.5}
  .pdf-sum-two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .pdf-table.tight th,.pdf-table.tight td{font-size:10px;padding:3px 4px}
</style>
</head>
<body>
<div class="wrap">
  <h1>みらた運用シミュレーター</h1>

  <div class="card stack">
    <div class="row">
      <div>
        <label>コース選択</label>
        <select id="course">
          <option value="withdraw">定期引出タイプ</option>
          <option value="target">ターゲットタイプ</option>
        </select>
      </div>
      <div>
        <label>初期投資額（万円）</label>
        <input id="principal" type="number" min="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>変額部分の割合（％）</label>
        <input id="varRatio" type="number" min="0" max="100" step="0.1" />
      </div>
      <div>
        <label>想定利回り（年率・％）</label>
        <input id="rate" type="number" step="0.1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>運用年数（年）</label>
        <input id="years" type="number" min="1" step="1" />
      </div>
      <div>
        <label>終身部分の最終倍率（％）</label>
        <input id="wlFinalPct" type="number" step="0.1" />
      </div>
    </div>

    <div class="row" id="targetRow">
      <div>
        <label>ターゲット（任意）</label>
        <input id="targetPct" type="number" min="0" step="1" />
      </div>
      <div></div>
    </div>

    <div class="btns">
      <button id="run">シミュレーション実行</button>
      <button id="addPlan" class="secondary" type="button" disabled>プラン追加</button>
      <button id="openList" class="secondary" type="button">プラン一覧</button>
      <button id="reset" class="secondary" type="button">リセット</button>
    </div>

    <div class="caption">
      計算の考え方：<br>
      ・<b>定期引出タイプ</b>… 「前年末残高×(1+利回り)」を残年数で割った額をその年の引出額。<br>
      ・<b>ターゲットタイプ</b>… 変額部分は複利成長（引出なし）。<br>
      ・終身部分は元本に対して<b>最終倍率</b>まで直線的に増加（単純推移）。
    </div>
  </div>

  <div id="results" class="hide">
    <div class="cols cols-2" id="cols">
      <div class="card">
        <h3 style="margin:0 0 8px;font-size:16px">変額部分</h3>
        <table id="tblVar"><thead></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px;font-size:16px">終身部分</h3>
        <table id="tblWL"><thead><tr><th>年</th><th>年末残高（万円）</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card" id="sumTableCard">
        <h3 style="margin:0 0 8px;font-size:16px">合計額（変額＋終身）</h3>
        <table id="tblTotal"><thead><tr><th>年</th><th>年末合計（万円）</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="sum">
      <div class="kpi"><div class="label" id="sumLabelL">変額部分</div><div class="val" id="sumL">-</div></div>
      <div class="kpi"><div class="label">終身部分 最終額</div><div class="val" id="sumWL">-</div></div>
    </div>
    <div class="sum" style="margin-top:8px">
      <div class="kpi" style="grid-column:1 / -1">
        <div class="label">運用後解約返戻金額</div><div class="val" id="grand">-</div>
      </div>
    </div>

    <div id="targetBanner" class="banner hide">
      <span class="icon">👑</span><span id="targetText"></span>
    </div>

    <div class="disclaimer" id="mainDisclaimer">
      ※ 本ツールの結果は試算であり、将来の成果や受取額を保証するものではありません。実際の契約条件・費用・税金・為替変動や市場価格調整（MVA）等の影響により結果は異なります。必ず最新の書面・設計書をご確認ください。小数点第二位以下切り捨て。
    </div>

    <div class="card chart-card">
      <h3 style="margin:0 0 8px;font-size:16px">推移グラフ（終身ベースに上乗せ表示）</h3>
      <canvas id="growthChart"></canvas>
      <div class="caption">ターゲット線＆達成年は王冠で表示します。</div>
    </div>
  </div>
</div>

<!-- オーバーレイ（プラン一覧） -->
<div id="overlay" class="overlay">
  <div class="sheet">
    <header>
      <div class="hwrap">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="closeOverlay" class="ghost" type="button">閉じる</button>
          <button id="restoreHiddenBtn" class="ghost" type="button">全ての隠したプランを復元（0件）</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="deleteAllBtn" class="ghost" type="button">プラン全削除</button>
          <button id="printBtn" class="secondary" type="button">全てPDFにする</button>
        </div>
      </div>
    </header>
    <main><div class="center"><div id="planList" class="planlist"></div></div></main>
  </div>
</div>

<!-- ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<div id="pdf-work"></div>

<script>
(function(){
  function $(id){ return document.getElementById(id); }

  /* 1桁小数・第二位以下切り捨て */
  function trunc1(n){ n = Number(n ?? 0); return n >= 0 ? Math.floor(n*10)/10 : Math.ceil(n*10)/10; }
  function fmt(n){ const t = trunc1(n); return t.toLocaleString("ja-JP", { minimumFractionDigits:1, maximumFractionDigits:1 }); }
  function fmt2(n){ const t = trunc1(n); return t.toLocaleString("ja-JP", { minimumFractionDigits:1, maximumFractionDigits:1 }); }

  const DISCLAIMER = '※ 本ツールの結果は試算であり、将来の成果や受取額を保証するものではありません。実際の契約条件・費用・税金・為替変動や市場価格調整（MVA）等の影響により結果は異なります。必ず最新の書面・設計書をご確認ください。小数点第二位以下切り捨て。';

  function isTargetCourse(){ return $("course").value === "target"; }
  function nowString(){ const d=new Date(); const p=n=>String(n).padStart(2,"0");
    return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes()); }

  var STORAGE_KEY = "mirata_plans_store";
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function safeParse(s){ try{return JSON.parse(s);}catch(e){return null;} }
  function loadStore(){ var raw = localStorage.getItem(STORAGE_KEY); var base = raw ? safeParse(raw) : {inbox:[]}; base.inbox = base.inbox || []; return base; }
  function saveStore(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

  function clearTables(){
    $("tblVar").querySelector("thead").innerHTML="";
    $("tblVar").querySelector("tbody").innerHTML="";
    $("tblWL").querySelector("tbody").innerHTML="";
    $("tblTotal").querySelector("tbody").innerHTML="";
  }
  function setLayoutByCourse(){
    var tgt=isTargetCourse();
    var row=$("targetRow");
    if(tgt){ row.classList.add('show'); } else { row.classList.remove('show'); }
    var cols=$("cols"); cols.classList.remove("cols-2","cols-3"); cols.classList.add(tgt?"cols-3":"cols-2");
    $("sumTableCard").style.display = tgt ? "block" : "none";
    if(!tgt){ $("targetBanner").classList.add("hide"); $("targetText").textContent=""; }
  }
  function resetAll(){
    ["principal","varRatio","rate","years","wlFinalPct","targetPct"].forEach(function(k){ $(k).value=""; });
    clearTables(); $("targetBanner").classList.add("hide"); $("targetText").textContent="";
    $("results").classList.add("hide"); destroyChart(); lastRun=null; $("addPlan").disabled=true;
  }

  /* ===== Chart 軸ロジック（v41d / v41e） ===== */
  var chart;
  function yMax_v41d(topNeed){
    if(topNeed<=0) return 10;
    var minFill = 2/3;
    var upper = topNeed / minFill;
    var p = Math.floor(Math.log10(topNeed));
    var best = upper;
    var ticks = [1,1.2,1.25,1.5,1.75,2,2.5,3,3.5,4,4.5,5,6,7.5,8,9,10];
    for(var e=p-1; e<=p+2; e++){
      var base = Math.pow(10, e);
      for(var i=0;i<ticks.length;i++){
        var cand = ticks[i]*base;
        if(cand >= topNeed && cand <= upper && cand < best) best = cand;
      }
    }
    return best;
  }
  function niceUp(v){
    if(v<=0) return 10;
    var p = Math.floor(Math.log10(v));
    var ticks = [1,1.2,1.25,1.5,1.75,2,2.5,3,3.5,4,4.5,5,6,7.5,8,9,10];
    for(var e=p-1; e<=p+2; e++){
      var base = Math.pow(10, e);
      for(var i=0;i<ticks.length;i++){
        var cand = ticks[i]*base;
        if(cand >= v) return cand;
      }
    }
    return Math.pow(10, p+1);
  }
  function yMax_v41e(topNeed, targetFill){
    targetFill = Math.min(Math.max(targetFill||0.70, 0.55), 0.90);
    var desired = (topNeed||1) / targetFill;
    return niceUp(desired*1.001);
  }

  var crownPlugin = { id:'crownPlugin', afterDatasetsDraw:function(c,a,opt){
    if(!opt || !opt.point) return;
    var ctx=c.ctx, x=c.scales.x, y=c.scales.y, i=opt.point.i, yv=opt.point.y;
    ctx.save(); ctx.font='20px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='alphabetic';
    ctx.fillText('👑', x.getPixelForValue(i), y.getPixelForValue(yv)-8); ctx.restore();
  }};
  if(window.Chart){
    if(window['chartjs-plugin-annotation']) Chart.register(window['chartjs-plugin-annotation']);
    Chart.register(crownPlugin);
  }
  function destroyChart(){ if(chart){ chart.destroy(); chart=undefined; } }

  function renderChart(labels, varSeries, wlSeries, opts){
    if(!window.Chart){ console.warn('Chart.js が未読込のためグラフはスキップ'); return; }
    destroyChart();
    var ctx=$("growthChart").getContext("2d");
    var totals=varSeries.map(function(v,i){ return v + (wlSeries[i]||0); });
    var topNeed = Math.max(Math.max.apply(null, totals), (opts && opts.targetAbs)||0);
    var yMax = (opts && opts.course === 'withdraw')
      ? yMax_v41e(topNeed, 0.70)
      : yMax_v41d(topNeed);

    var xTickConf = (labels.length>40)
      ? { autoSkip:true, maxTicksLimit:20 }
      : { autoSkip:false };

    var annotations={};
    if(opts && opts.targetAbs && opts.targetAbs>0){
      annotations.target = {
        type:'line', yMin:opts.targetAbs, yMax:opts.targetAbs,
        borderColor:'#f59e0b', borderWidth:2, borderDash:[6,6],
        label:{enabled:true, content:'ターゲット '+Math.round((opts.targetPct||0)*100)+'%', position:'end', backgroundColor:'#fff'}
      };
    }

    chart = new Chart(ctx, {
      type:'line',
      data:{labels:labels, datasets:[
        {label:'終身部分', data:wlSeries, borderWidth:2, tension:0.2, pointRadius:0, fill:true,
         backgroundColor:'rgba(2,132,199,.15)', borderColor:'rgba(2,132,199,1)', stack:'S'},
        {label:'変額部分', data:varSeries, borderWidth:2, tension:0.2, pointRadius:0, fill:true,
         backgroundColor:'rgba(16,185,129,.18)', borderColor:'rgba(16,185,129,1)', stack:'S'}
      ]},
      options:{
        responsive:true, maintainAspectRatio:false,
        interaction:{mode:'index', intersect:false},
        scales:{
          y:{beginAtZero:true,stacked:true,max:yMax,title:{display:true,text:'万円'},
             ticks:{callback:function(v){
               const t = trunc1(v);
               return t.toLocaleString('ja-JP',{minimumFractionDigits:1,maximumFractionDigits:1});
             }} },
          x:{ticks:xTickConf}
        },
        plugins:{
          legend:{labels:{usePointStyle:true, boxWidth:8}},
          annotation:{annotations:annotations},
          tooltip:{
            itemSort:function(a,b){ return (a.dataset.label==='変額部分'?0:1)-(b.dataset.label==='変額部分'?0:1); },
            callbacks:{
              label:function(ctx){
                var raw=(ctx.raw!=null)?ctx.raw:0;
                return ctx.dataset.label+': '+fmt(raw)+' 万円';
              },
              afterBody:function(items){
                if(!(opts && opts.withdrawals)) return '';
                var i=items[0].dataIndex, wd=opts.withdrawals[i];
                return (wd!=null)?('引出額: '+fmt(wd)+' 万円'):'';
              },
              footer:function(items){
                var wl=0,vr=0; for(var k=0;k<items.length;k++){ var it=items[k]; if(it.dataset.label==='変額部分') vr=it.raw||0; else wl=it.raw||0; }
                return '合計: '+fmt(wl+vr)+' 万円';
              },
              footerFont:{weight:'bold'}
            }
          },
          crownPlugin:{ point: (opts && opts.crownPoint) ? opts.crownPoint : null }
        }
      }
    });
  }

  var lastRun=null;
  function linearPath(start,end,years){var arr=[],step=(end-start)/years;for(var y=1;y<=years;y++)arr.push(start+step*y);return arr;}
  function run(){
    setLayoutByCourse();
    var tgt=isTargetCourse();
    var P=Number($("principal").value||0);
    var r=Number($("rate").value||0)/100;
    var n=Math.max(1, Number($("years").value||0));
    var vr=Math.min(100, Math.max(0, Number($("varRatio").value||0)))/100;
    var wlFinalPct=Number($("wlFinalPct").value||0)/100;
    var targetPct=Number($("targetPct").value||0)/100;

    var var0=P*vr, wl0=P-var0, wlEnd=P*wlFinalPct;
    clearTables();

    var wlSeries = linearPath(wl0, wlEnd, n);
    $("tblWL").querySelector("tbody").innerHTML = wlSeries.map(function(v,i){return '<tr><td>'+(i+1)+'</td><td>'+fmt(v)+'</td></tr>';}).join('');

    var labels=[], varSeries=[], totalSeries=[], withdrawals=null;
    var sumLabelL="", leftVal=0, grand=0;
    var crownPoint=null, targetAbs=null, reachedYear=0;
    for(var i=1;i<=n;i++) labels.push(String(i));

    if(!tgt){
      withdrawals=[];
      $("tblVar").querySelector("thead").innerHTML='<tr><th>年</th><th>引出額（万円）</th><th>年末残高（万円）</th></tr>';
      var tb=$("tblVar").querySelector("tbody");
      var bal=var0,totalWD=0;
      for(var y=1;y<=n;y++){
        bal=bal*(1+r);
        var wd=bal/(n-y+1);
        bal-=wd; totalWD+=wd;
        withdrawals.push(wd); varSeries.push(bal); totalSeries.push(bal+wlSeries[y-1]);
        tb.insertAdjacentHTML('beforeend','<tr><td>'+y+'</td><td>'+fmt(wd)+'</td><td>'+fmt(bal)+'</td></tr>');
      }
      sumLabelL="変額部分 引出合計額"; leftVal=totalWD; grand=wlEnd;
      $("targetBanner").classList.add("hide"); $("targetText").textContent="";
      $("tblTotal").querySelector("tbody").innerHTML="";
    }else{
      $("tblVar").querySelector("thead").innerHTML='<tr><th>年</th><th>年末残高（万円）</th></tr>';
      var tb2=$("tblVar").querySelector("tbody");
      var totalBody=$("tblTotal").querySelector("tbody");
      var bal2=var0; targetAbs = (targetPct>0)?(P*targetPct):null;

      for(var y2=1;y2<=n;y2++){
        bal2=bal2*(1+r);
        varSeries.push(bal2);
        var total=bal2 + wlSeries[y2-1];
        totalSeries.push(total);
        tb2.insertAdjacentHTML("beforeend", '<tr><td>'+y2+'</td><td>'+fmt(bal2)+'</td></tr>');

        var crowned = (!reachedYear && targetAbs && total>=targetAbs);
        if(crowned){ reachedYear=y2; crownPoint={i:y2-1, y:total}; }
        totalBody.insertAdjacentHTML("beforeend", '<tr><td>'+y2+'</td><td style="text-align:right">'+(crowned?'👑 ':'')+fmt(total)+'</td></tr>');
      }
      sumLabelL="変額部分 最終額"; leftVal=varSeries[varSeries.length-1]||0; grand=leftVal+wlEnd;
      if(targetAbs && reachedYear>0){
        $("targetText").textContent='ターゲット達成年数：'+reachedYear+'年目（'+Math.round(targetPct*100)+'%）';
        $("targetBanner").classList.remove("hide");
      }else{
        $("targetBanner").classList.add("hide"); $("targetText").textContent="";
      }
    }

    $("sumLabelL").textContent=sumLabelL;
    $("sumL").textContent=fmt(leftVal)+' 万円';
    $("sumWL").textContent=fmt(wlEnd)+' 万円';
    $("grand").textContent=fmt(grand)+' 万円';

    renderChart(labels, varSeries, wlSeries, {
      course: tgt ? 'target' : 'withdraw',
      targetAbs:targetAbs, targetPct:targetPct, crownPoint:crownPoint, withdrawals:withdrawals
    });

    lastRun = {inputs:{course:$("course").value,P:P,r:r,n:n,vr:vr,wlFinalPct:wlFinalPct,targetPct:targetPct},
               labels:labels,varSeries:varSeries,wlSeries:wlSeries,totalSeries:totalSeries,withdrawals:withdrawals,
               kpi:{sumLabelL:sumLabelL,leftVal:leftVal,wlEnd:wlEnd,grand:grand},
               target:{abs:targetAbs,pct:targetPct,crown:crownPoint}};
    $("results").classList.remove("hide");
    $("addPlan").disabled=false;
  }

  /* プラン一覧 */
  var overlay=$("overlay");
  function openOverlay(){ renderOverlay(); overlay.classList.add("show"); document.body.style.overflow="hidden"; }
  function closeOverlay(){ overlay.classList.remove("show"); document.body.style.overflow=""; }

  function updateHiddenCountLabel(){
    var s = loadStore();
    var hiddenNum = (s.inbox||[]).filter(function(p){ return p.hidden; }).length;
    var btn = $("restoreHiddenBtn");
    if(btn){ btn.textContent = '全ての隠したプランを復元（' + hiddenNum + '件）'; }
  }

  function renderOverlay(){
    var s=loadStore(), list=$("planList"); list.innerHTML="";
    var arr = (s.inbox||[]).filter(function(p){return !p.hidden;});
    if(arr.length===0){
      list.innerHTML='<div class="plancard"><div class="muted">表示できるプランがありません。</div></div>';
      $("printBtn").disabled=true;
    }else{
      $("printBtn").disabled=false;
      arr.forEach(function(p){ list.appendChild(renderCard(p)); });
    }
    updateHiddenCountLabel();
  }

  function renderCard(p){
    var s=p.snapshot, isTarget=(s.inputs && s.inputs.course==="target");
    var card=document.createElement("div"); card.className="plancard";
    var title=(p.name||"（名称未設定）");
    var I = s.inputs || {};
    var vrPct = (I.vr*100).toFixed(1);
    var rPct  = (I.r*100).toFixed(1);
    var wlPct = (I.wlFinalPct*100).toFixed(1);
    var nYear = I.n;
    var tgtStr = isTarget ? (I.targetPct>0 ? (I.targetPct*100).toFixed(1)+'%' : '（未設定）') : '';

    var html = ''
    +'<div class="headerGrid">'
    +  '<div class="thumbLarge">'+(s.chartImg?('<img src="'+s.chartImg+'" alt="chart">'):'')+'</div>'
    +  '<div class="titleBox">'
    +    '<div><span class="tag">'+(isTarget?'ターゲット':'定期引出')+'</span></div>'
    +    '<input class="title" placeholder="プラン名（任意）" value="'+title+'">'
    +    '<div class="muted">'
    +      '作成：'+(p.createdAt||'')+'<br>'
    +      '初期投資額：'+fmt(I.P||0)+' 万円<br>'
    +      '年率：'+rPct+'% ／ 変額割合：'+vrPct+'% ／ 年数：'+nYear+'年<br>'
    +      '終身最終倍率：'+wlPct+'%'+(isTarget?(' ／ ターゲット：'+tgtStr):'')
    +    '</div>'
    +  '</div>'
    +'</div>'
    +'<div class="rowbtns" style="margin-top:6px">'
    +  (p.hidden ? '<button class="ok" data-act="restore">復元</button>' : '<button class="ok" data-act="hide">隠す</button>')
    +  '<button class="secondary" data-act="apply">この入力で再試算</button>'
    +  '<button class="secondary" data-act="pdf1">PDFにする</button>'
    +  '<button class="danger" data-act="delete">削除</button>'
    +'</div>'
    +'<div class="mini">'+renderMini(s,isTarget)+'</div>';
    card.innerHTML=html;

    const titleInput = card.querySelector('input.title');
    titleInput.addEventListener('change', function(e){
      var st=loadStore();
      var t=(e.target.value||'').trim();
      for(var i=0;i<st.inbox.length;i++){ if(st.inbox[i].id===p.id){ st.inbox[i].name=t||st.inbox[i].name; break; } }
      saveStore(st);
    });

    var btnHide = card.querySelector('[data-act="hide"]');
    if(btnHide){ btnHide.addEventListener('click', function(){
      var st=loadStore(); for(var i=0;i<st.inbox.length;i++){ if(st.inbox[i].id===p.id){ st.inbox[i].hidden=true; break; } }
      saveStore(st); renderOverlay();
    });}
    var btnRestore = card.querySelector('[data-act="restore"]');
    if(btnRestore){ btnRestore.addEventListener('click', function(){
      var st=loadStore(); for(var i=0;i<st.inbox.length;i++){ if(st.inbox[i].id===p.id){ st.inbox[i].hidden=false; break; } }
      saveStore(st); renderOverlay();
    });}
    card.querySelector('[data-act="delete"]').addEventListener('click', function(){
      var st=loadStore(); if(!confirm("このプランを削除しますか？")) return;
      st.inbox = (st.inbox||[]).filter(function(x){return x.id!==p.id;}); saveStore(st); renderOverlay();
    });

    card.querySelector('[data-act="apply"]').addEventListener('click', function(){
      var I = p.snapshot.inputs || {};
      $("course").value = (I.course === 'target') ? 'target' : 'withdraw';
      $("principal").value  = I.P!=null ? I.P : '';
      $("varRatio").value   = I.vr!=null ? (I.vr*100).toFixed(1) : '';
      $("rate").value       = I.r!=null ? (I.r*100).toFixed(1) : '';
      $("years").value      = I.n!=null ? I.n : '';
      $("wlFinalPct").value = I.wlFinalPct!=null ? (I.wlFinalPct*100).toFixed(1) : '';
      $("targetPct").value  = I.targetPct!=null ? (I.targetPct*100).toFixed(1) : '';
      setLayoutByCourse();
      closeOverlay();
      run();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    card.querySelector('[data-act="pdf1"]').addEventListener('click', function(){
      var liveName = (titleInput.value||'').trim() || p.name || '（名称未設定）';
      exportPlanAsPdf(p, liveName);
    });

    return card;
  }

  /* 画面２ミニビュー：表 → ※ → グラフ */
  function renderMini(s,isTarget){
    var varHead=isTarget?'<tr><th>年</th><th>年末残高（万円）</th></tr>':'<tr><th>年</th><th>引出額（万円）</th><th>年末残高（万円）</th></tr>';
    var varRows=s.labels.map(function(l,i){ return isTarget?('<tr><td>'+l+'</td><td>'+fmt(s.varSeries[i])+'</td></tr>'):( '<tr><td>'+l+'</td><td>'+fmt(s.withdrawals[i])+'</td><td>'+fmt(s.varSeries[i])+'</td></tr>' ); }).join("");
    var wlRows=s.labels.map(function(l,i){ return '<tr><td>'+l+'</td><td>'+fmt(s.wlSeries[i])+'</td></tr>'; }).join("");
    var totalBlock="";
    if(isTarget){
      totalBlock = '<div class="gbox"><h4>合計額（変額＋終身）</h4><table><thead><tr><th>年</th><th>年末合計（万円）</th></tr></thead><tbody>'
        + s.labels.map(function(l,i){ var cr=(s.target && s.target.abs && s.target.crown && s.target.crown.i===i)?'👑 ':''; return '<tr><td>'+l+'</td><td>'+cr+fmt(s.totalSeries[i])+'</td></tr>'; }).join("")
        + '</tbody></table></div>';
    }
    var tablesHtml = '<div class="'+(isTarget?'grid-3':'grid-2')+'">'
      +  '<div class="gbox"><h4>変額部分</h4><table><thead>'+varHead+'</thead><tbody>'+varRows+'</tbody></table></div>'
      +  '<div class="gbox"><h4>終身部分</h4><table><thead><tr><th>年</th><th>年末残高（万円）</th></tr></thead><tbody>'+wlRows+'</tbody></table></div>'
      +  totalBlock
      +'</div>';

    var chartHtml = '<div class="gbox" style="margin-top:8px"><h4>推移グラフ</h4>'
      +(s.chartImg?('<img src="'+s.chartImg+'" alt="chart" style="width:100%;max-height:160px;object-fit:contain;border:1px solid #e5e7eb;border-radius:4px">')
                  :'<div class="muted">（グラフ無し）</div>')
      +'</div>';

    return tablesHtml + '<div class="disclaimer" style="margin-top:8px">'+DISCLAIMER+'</div>' + chartHtml;
  }

  /* ===== PDF ===== */
  function getJsPDF(){
    if (window.jspdf && window.jspdf.jsPDF) return window.jspdf.jsPDF;
    alert('PDF機能の読み込みに失敗しました。ネット接続をご確認ください。');
    throw new Error('jsPDF not loaded');
  }

  function allRows(snapshot){
    var crownIndex = (snapshot.target && snapshot.target.crown && typeof snapshot.target.crown.i==='number')
      ? snapshot.target.crown.i : -1;
    var rows=[], n=snapshot.labels.length, tgt=(snapshot.inputs.course==='target');
    for(var i=0;i<n;i++){
      var totalVal = snapshot.totalSeries ? snapshot.totalSeries[i] : (snapshot.varSeries[i]+snapshot.wlSeries[i]);
      var totalStr = (i===crownIndex ? '👑 ' : '') + fmt2(totalVal);
      if(tgt){
        rows.push([ String(i+1), fmt2(snapshot.varSeries[i]), fmt2(snapshot.wlSeries[i]), totalStr ]);
      }else{
        rows.push([ String(i+1), fmt2(snapshot.withdrawals[i]), fmt2(snapshot.varSeries[i]), fmt2(snapshot.wlSeries[i]), totalStr ]);
      }
    }
    return rows;
  }

  function splitRows(rows){
    if(rows.length <= 50) return [rows];
    var half = Math.ceil(rows.length/2);
    return [rows.slice(0,half), rows.slice(half)];
  }

  function tableHTML(rowsSegment, isTarget){
    var veryMany = rowsSegment.length > 30;
    var twoCol   = rowsSegment.length > 18;
    var half = Math.ceil(rowsSegment.length/2);
    var left = rowsSegment.slice(0, half), right = rowsSegment.slice(half);

    var head5 = '<thead><tr><th>年</th><th>引出額（万）</th><th>変額残高（万）</th><th>終身残高（万）</th><th>合計（万）</th></tr></thead>';
    var head4 = '<thead><tr><th>年</th><th>変額残高（万）</th><th>終身残高（万）</th><th>合計（万）</th></tr></thead>';
    var head  = isTarget ? head4 : head5;

    function t(r,tight){
      return `<table class="pdf-table ${tight?'tight':''}">${head}<tbody>${
        r.map(rr=>`<tr>${rr.map((c,j)=>`<td${j===0?' style="text-align:center"':''}>${c}</td>`).join('')}</tr>`).join('')
      }</tbody></table>`;
    }
    if(twoCol){ return `<div class="pdf-sum-two">${t(left, veryMany)}${t(right, veryMany)}</div>`; }
    else{ return t(rowsSegment, false); }
  }

  function buildPdfPage(p, titleText, badgeText, rowsSegment, includeChart){
    var s=p.snapshot, isTarget=(s.inputs.course==='target');
    var chartH = rowsSegment.length>18 ? (rowsSegment.length>30? 240 : 260) : 330;

    var root = document.createElement('div');
    root.className='pdf-a4';
    root.innerHTML = `
      <div class="pdf-head">
        <div>
          <div class="pdf-title"><span>${titleText}</span>${badgeText?`<span class="page-badge">${badgeText}</span>`:''}</div>
          <div class="pdf-meta">
            コース：${isTarget?'ターゲットタイプ':'定期引出タイプ'} ／
            初期投資：${fmt2(s.inputs.P)} 万円 ／
            変額割合：${(s.inputs.vr*100).toFixed(1)}% ／
            年率：${(s.inputs.r*100).toFixed(1)}% ／
            年数：${s.inputs.n}年 ／
            終身最終倍率：${(s.inputs.wlFinalPct*100).toFixed(1)}%${isTarget && s.inputs.targetPct>0 ? ' ／ ターゲット：'+(s.inputs.targetPct*100).toFixed(1)+'%' : ''}
          </div>
        </div>
        <div class="pdf-meta">${p.createdAt||''}</div>
      </div>

      <div class="pdf-card">
        <h3>年次サマリー</h3>
        ${tableHTML(rowsSegment, isTarget)}
      </div>

      <div class="pdf-note">
        ${DISCLAIMER}
      </div>

      <div class="pdf-card">
        <h3>推移グラフ（参考）</h3>
        ${includeChart
          ? (s.chartImg ? `<img class="pdf-chart" style="height:${chartH}px" src="${s.chartImg}" />`
                        : `<div class="pdf-chart" style="height:${chartH}px;display:flex;align-items:center;justify-content:center;color:#6b7280">グラフ無し</div>`)
          : `<div class="pdf-note">（このページにはグラフは含めていません）</div>`}
      </div>
    `;
    return root;
  }

  function buildPdfPages(p, titleText){
    var rows = allRows(p.snapshot);
    var segments = splitRows(rows);
    var pages = [];
    var multi = segments.length>1;
    for(var i=0;i<segments.length;i++){
      var badgeText = multi ? '（'+(i+1)+'/'+segments.length+'）' : '';
      var includeChart = multi ? (i===segments.length-1) : true;
      pages.push( buildPdfPage(p, titleText, badgeText, segments[i], includeChart) );
    }
    return pages;
  }

  async function sheetToImage(sheetEl){
    if(document.fonts && document.fonts.ready){ await document.fonts.ready; }
    await new Promise(r => requestAnimationFrame(() => setTimeout(r, 50)));
    if(!window.html2canvas){ throw new Error('html2canvas not loaded'); }
    const canvas = await html2canvas(sheetEl, { backgroundColor:'#ffffff', scale:2, useCORS:true, logging:false });
    return canvas.toDataURL('image/png');
  }

  async function exportPlanAsPdf(p, nameOverride){
    const jsPDF = getJsPDF();
    const titleText = nameOverride || p.name || '（名称未設定）';
    const pages = buildPdfPages(p, titleText);
    const work = $("pdf-work");
    const doc = new jsPDF({orientation:'portrait', unit:'mm', format:'a4'});

    for(let i=0;i<pages.length;i++){
      work.appendChild(pages[i]);
      const img = await sheetToImage(pages[i]);
      work.removeChild(pages[i]);
      if(i>0) doc.addPage('a4','portrait');
      doc.addImage(img, 'PNG', 0, 0, 210, 297);
    }
    doc.save((titleText||'plan')+'_'+nowString()+'.pdf');
  }

  async function exportAllPlansPdf(){
    const jsPDF = getJsPDF();
    var s=loadStore();
    var targets=(s.inbox||[]).filter(function(p){return !p.hidden;});
    if(targets.length===0){ alert("PDFにする対象のプランがありません。"); return; }

    const work = $("pdf-work");
    const doc = new jsPDF({orientation:'portrait', unit:'mm', format:'a4'});
    let pageAdded = false;

    for(let p of targets){
      const nameText = p.name || '（名称未設定）';
      const pages = buildPdfPages(p, nameText);
      for(let i=0;i<pages.length;i++){
        work.appendChild(pages[i]);
        const img = await sheetToImage(pages[i]);
        work.removeChild(pages[i]);
        if(pageAdded) doc.addPage('a4','portrait');
        doc.addImage(img, 'PNG', 0, 0, 210, 297);
        pageAdded = true;
      }
    }
    doc.save('mirata_plans_' + nowString() + '.pdf');
  }

  $("printBtn").addEventListener("click", exportAllPlansPdf);
  $("restoreHiddenBtn").addEventListener("click", function(){
    var s = loadStore();
    var changed = 0;
    for(var i=0;i<s.inbox.length;i++){
      if(s.inbox[i].hidden){ s.inbox[i].hidden=false; changed++; }
    }
    if(changed===0){ alert("復元するプランがありません。"); return; }
    saveStore(s);
    alert("隠したプランを全て復元しました（"+changed+"件）。");
    renderOverlay();
  });

  $("deleteAllBtn").addEventListener("click", function(){
    var s=loadStore();
    if(!s.inbox || s.inbox.length===0){ alert("削除するプランがありません。"); return; }
    if(confirm('現在のプランを全て削除します。よろしいですか？')){
      s.inbox=[]; saveStore(s); renderOverlay();
    }
  });

  $("course").addEventListener("change", setLayoutByCourse);
  $("run").addEventListener("click", run);
  $("reset").addEventListener("click", resetAll);
  $("openList").addEventListener("click", openOverlay);
  $("closeOverlay").addEventListener("click", closeOverlay);

  $("addPlan").addEventListener("click", function(){
    if(!lastRun){ alert("先にシミュレーションを実行してください。"); return; }
    if(!window.Chart){ alert("グラフ機能の初期化に失敗しました。ネット接続をご確認ください。"); return; }
    (function capture(cb){
      if(!chart){ cb(""); return; }
      chart.update(); requestAnimationFrame(function(){ setTimeout(function(){ cb(chart.toBase64Image()); },60); });
    })(function(chartImg){
      var s=loadStore(); var createdAt=new Date().toISOString().slice(0,16).replace('T',' ');
      s.inbox.push({id:uid(), name:"", hidden:false, createdAt:createdAt, snapshot:Object.assign({}, lastRun, {chartImg:chartImg})});
      saveStore(s);
      $("addPlan").disabled=true;
      alert("プランを保存しました。プラン一覧で確認できます。");
    });
  });

  /* 初期レイアウトはとにかく「定期引出＝ターゲット欄なし」 */
  setLayoutByCourse();
})();
</script>
</body>
</html>

